<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenMind | Pro Dashboard</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #2ecc71;
            --bg: #080808;
            --surface: #121212;
            --card-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-dim: #a0a0a0;
            --sidebar-w: 260px;
            --danger: #ff4757;
        }

        .light-mode {
            --bg: #f5f6fa;
            --surface: #ffffff;
            --card-border: rgba(0, 0, 0, 0.05);
            --text-main: #2f3640;
            --text-dim: #7f8c8d;
        }

        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: background 0.3s, color 0.3s; }
        body { margin: 0; background-color: var(--bg); color: var(--text-main); display: flex; overflow: hidden; height: 100vh; }

        #auth-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: radial-gradient(circle at top right, #1a2a1f, #080808);
            display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(15px);
            padding: 40px; border-radius: 28px; width: 360px;
            border: 1px solid var(--card-border); text-align: center;
        }
        .login-card input {
            width: 100%; padding: 14px; margin: 10px 0;
            background: rgba(255,255,255,0.05); border: 1px solid var(--card-border);
            border-radius: 12px; color: white; outline: none;
        }

        .sidebar {
            width: var(--sidebar-w); background: var(--surface);
            border-right: 1px solid var(--card-border);
            padding: 24px; display: flex; flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; z-index: 100; height: 100vh;
        }
        .sidebar.collapsed { width: 80px; padding: 24px 12px; }
        .sidebar.collapsed .nav-text, .sidebar.collapsed h2, .sidebar.collapsed .session-info, .sidebar.collapsed .theme-text { display: none; }

        .nav-content { flex-grow: 1; }

        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 14px;
            border-radius: 14px; color: var(--text-dim); cursor: pointer;
            transition: 0.3s; margin-bottom: 8px;
        }
        .nav-item:hover, .nav-item.active { background: rgba(46, 204, 113, 0.1); color: var(--primary); }

        .main { flex: 1; overflow-y: auto; padding: 40px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; }
        
        .card {
            background: var(--surface); padding: 24px; border-radius: 24px;
            border: 1px solid var(--card-border); transition: 0.3s; position: relative;
        }
        
        /* Adjusted Chart Container to be smaller */
        .chart-container { height: 180px; position: relative; margin-top: 10px; }

        .val { font-size: 2.2rem; font-weight: 800; color: var(--primary); margin: 8px 0; }
        
        .switch { position: relative; width: 42px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .status-pill { padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; border: 1px solid #444; display: flex; align-items: center; gap: 5px; }
        .active-on { color: #2ecc71; border-color: #2ecc71; }

        .alert-badge { position: absolute; top: 15px; right: 15px; background: var(--danger); color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; display: none; }

        #status-box { 
            height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; 
            color: #888; background: rgba(0,0,0,0.1); padding: 15px; border-radius: 12px; border: 1px solid var(--card-border);
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .log-time { color: var(--primary); margin-right: 10px; }

        .hidden { display: none; }
        .btn { padding: 12px 24px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; }
        .btn-logout { background: rgba(255, 71, 87, 0.1); color: var(--danger); width: 100%; }

        /* Table Styling for Logic */
        .logic-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85rem; }
        .logic-table th { background: rgba(46, 204, 113, 0.1); color: var(--primary); text-align: left; padding: 12px; border-bottom: 2px solid var(--card-border); }
        .logic-table td { padding: 12px; border-bottom: 1px solid var(--card-border); color: var(--text-dim); }

        .pulse { width: 10px; height: 10px; background: #2ecc71; border-radius: 50%; display: inline-block; margin-right: 8px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .session-info { font-size: 10px; color: var(--text-dim); margin-bottom: 15px; padding: 15px 10px 0 10px; border-top: 1px solid var(--card-border); }
        #pump-timer { font-size: 0.7rem; color: var(--danger); font-weight: 800; visibility: hidden; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-card">
            <span class="material-symbols-rounded" style="font-size: 48px; color: var(--primary);">eco</span>
            <h2>GreenMind</h2>
            <p style="color: var(--text-dim); font-size: 0.8rem;">Thesis Research Portal</p>
            <input type="email" id="email" placeholder="Researcher Email">
            <input type="password" id="pass" placeholder="Security Token">
            <button class="btn" style="background:var(--primary); color:white; width:100%; margin-top: 10px;" onclick="login()">Authenticate</button>
        </div>
    </div>

    <div class="sidebar" id="sidebar" onmouseenter="expandSidbar()" onmouseleave="collapseSidebar()">
        <div class="nav-content">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 40px;">
                <span class="material-symbols-rounded" style="color: var(--primary);">potted_plant</span>
                <h2 style="font-size: 1.1rem; margin: 0;">GreenMind</h2>
            </div>
            
            <div class="nav-item active" onclick="show('v-dash', this)"><span class="material-symbols-rounded">grid_view</span><span class="nav-text">Dashboard</span></div>
            <div class="nav-item" onclick="show('v-flow', this)"><span class="material-symbols-rounded">account_tree</span><span class="nav-text">System Flow</span></div>
            <div class="nav-item" onclick="show('v-logs', this)"><span class="material-symbols-rounded">database</span><span class="nav-text">Data Logs</span></div>
            
            <div class="nav-item" onclick="toggleTheme()" style="margin-top: 20px;">
                <span class="material-symbols-rounded">dark_mode</span>
                <span class="nav-text theme-text">Switch Theme</span>
            </div>
        </div>
        
        <div class="session-info">
            <div style="margin-bottom: 5px;">SESSION ACTIVE</div>
            <div id="session-count">Records: 0</div>
        </div>
        <button class="btn btn-logout" onclick="logout()"><span class="material-symbols-rounded">logout</span><span class="nav-text" style="margin-left:10px;">End Session</span></button>
    </div>

    <div class="main">
        <div id="v-dash">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin: 0;">Live Telemetry</h1>
                    <p style="color: var(--text-dim); margin-bottom: 30px;">Automated GreenHouse Monitoring System</p>
                </div>
                <div id="sys-status" style="font-size: 0.8rem; font-weight: 600; color: var(--primary);">
                    <span class="pulse"></span> SYSTEM ONLINE
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <div id="alert-t" class="alert-badge">HIGH TEMP</div>
                    <span class="material-symbols-rounded" style="color: #ff6b6b;">thermostat</span>
                    <div style="color: var(--text-dim); margin-top:10px;">Temperature</div>
                    <div class="val"><span id="t">--</span>¬∞C</div>
                </div>
                <div class="card">
                    <div id="alert-h" class="alert-badge">HIGH HUMIDITY</div>
                    <span class="material-symbols-rounded" style="color: #48dbfb;">humidity_mid</span>
                    <div style="color: var(--text-dim); margin-top:10px;">Humidity</div>
                    <div class="val"><span id="h">--</span>%</div>
                </div>
                <div class="card">
                    <div id="alert-s" class="alert-badge">DRY SOIL</div>
                    <span class="material-symbols-rounded" style="color: #f1c40f;">grass</span>
                    <div style="color: var(--text-dim); margin-top:10px;">Soil Moisture</div>
                    <div class="val"><span id="s">--</span>%</div>
                </div>
            </div>

            <div class="grid" style="margin-top: 24px;">
                <div style="grid-column: span 2; display: flex; flex-direction: column; gap: 24px;">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h4 style="margin:0;">Analytics Trend</h4>
                            <div style="font-size: 10px; color: var(--text-dim);">Live 15-point Window</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h4 style="margin-top:0; display:flex; align-items:center; gap:8px;">
                            <span class="material-symbols-rounded">history_edu</span> Live Activity Log
                        </h4>
                        <div id="status-box">
                            <div class="log-entry">Waiting for system connection...</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top: 0;">Relay Control</h3>
                    <div style="display:flex; flex-direction:column; gap: 20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span class="material-symbols-rounded" id="icon-f" style="color: #888;">cyclone</span>
                                <span id="f-st" class="status-pill">FAN</span>
                            </div>
                            <label class="switch"><input type="checkbox" id="f-tog"><span class="slider"></span></label>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span class="material-symbols-rounded" id="icon-m" style="color: #888;">mist</span>
                                <span id="m-st" class="status-pill">MIST</span>
                            </div>
                            <label class="switch"><input type="checkbox" id="m-tog"><span class="slider"></span></label>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span class="material-symbols-rounded" id="icon-p" style="color: #888;">water_pump</span>
                                <span id="p-st" class="status-pill">PUMP</span>
                                <span id="pump-timer">TIMEOUT...</span>
                            </div>
                            <label class="switch"><input type="checkbox" id="p-tog"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div style="margin-top: 30px; padding: 15px; border-radius: 12px; background: rgba(127,127,127,0.05); font-size: 0.75rem; color: var(--text-dim);">
                        <p style="margin:0;"><b>Thesis Note:</b> Manual pump activation includes a 10s safety timeout to prevent reservoir depletion.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="v-flow" class="hidden">
            <h1>System Logic & Thresholds</h1>
            <div class="card">
                <table class="logic-table">
                    <thead>
                        <tr>
                            <th>System / Device</th>
                            <th>Sensor Used</th>
                            <th>Trigger (ON)</th>
                            <th>Stop (OFF)</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><b>üí® Fan</b></td>
                            <td>Temp / Humidity</td>
                            <td>Temp > 30¬∞C OR Hum > 85%</td>
                            <td>Temp ‚â§ 28¬∞C AND Hum ‚â§ 80%</td>
                            <td>Continuous run</td>
                        </tr>
                        <tr>
                            <td><b>üå´ Mist System</b></td>
                            <td>Temp / Humidity</td>
                            <td>Temp > 28¬∞C AND Hum < 60%</td>
                            <td>Hum ‚â• 80% OR Temp ‚â§ 26¬∞C</td>
                            <td>Pulse: 10‚Äì30s ON</td>
                        </tr>
                        <tr>
                            <td><b>üöø Water Pump</b></td>
                            <td>Soil Moisture</td>
                            <td>Soil < 25%</td>
                            <td>Soil ‚â• 50%</td>
                            <td>2‚Äì5 min max cycle</td>
                        </tr>
                        <tr>
                            <td><b>üö® Extreme Heat</b></td>
                            <td>Temperature</td>
                            <td>Temp ‚â• 35¬∞C</td>
                            <td>Temp < 33¬∞C</td>
                            <td>Fan/Mist ON, Pump OFF</td>
                        </tr>
                        <tr>
                            <td><b>‚è± System Loop</b></td>
                            <td>‚Äî</td>
                            <td>Every 5‚Äì10 sec</td>
                            <td>‚Äî</td>
                            <td>Anti-rapid switching</td>
                        </tr>
                        <tr>
                            <td><b>üîí Safety Lock</b></td>
                            <td>All sensors</td>
                            <td>Invalid Sensor Data</td>
                            <td>Manual reset</td>
                            <td>Prevents damage</td>
                        </tr>
                    </tbody>
                </table>

                <div style="margin-top: 40px; border-top: 1px solid var(--card-border); padding-top: 30px;">
                    <h2 style="display: flex; align-items: center; gap: 10px; color: var(--primary);">
                        <span class="material-symbols-rounded">sync_alt</span> SYSTEM FLOW OVERVIEW
                    </h2>
                    
                    <div style="display: flex; align-items: center; justify-content: space-around; background: rgba(127,127,127,0.05); padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                        <div>
                            <h4 style="margin-bottom: 10px;">Sensors</h4>
                            <div style="font-size: 0.85rem; color: var(--text-dim);">
                                üå° Temp<br>üíß Hum<br>üå± Soil
                            </div>
                        </div>
                        <span class="material-symbols-rounded" style="color: var(--primary);">arrow_forward</span>
                        <div>
                            <h4 style="margin-bottom: 10px;">Decision Logic</h4>
                            <div style="font-size: 1.5rem;">üß†</div>
                        </div>
                        <span class="material-symbols-rounded" style="color: var(--primary);">arrow_forward</span>
                        <div>
                            <h4 style="margin-bottom: 10px;">Actuators</h4>
                            <div style="font-size: 0.85rem; color: var(--text-dim);">
                                üí® Fan<br>üå´ Mist<br>üöø Pump
                            </div>
                        </div>
                    </div>

                    <h3 style="color: var(--primary); margin-bottom: 20px;">üß† MAIN CONTROL FLOW (STEP-BY-STEP)</h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        
                        <div style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 15px; border: 1px solid var(--card-border);">
                            <p><b>1Ô∏è‚É£ READ ALL SENSORS</b></p>
                            <ul style="font-size: 0.85rem; color: var(--text-dim); list-style: none; padding: 0;">
                                <li>‚Ä¢ Check Ambient Temperature</li>
                                <li>‚Ä¢ Check Relative Humidity</li>
                                <li>‚Ä¢ Check Soil Moisture Level</li>
                            </ul>
                            <p><b>2Ô∏è‚É£ FAN CONTROL</b></p>
                            <p style="font-size: 0.8rem; color: var(--text-dim);">
                                <span style="color: #2ecc71;">‚úÖ Trigger:</span> Temp > 30¬∞C OR Hum > 85%<br>
                                <span style="color: var(--primary);">üîÅ Logic:</span> If trigger met, FAN = ON; Else OFF.
                            </p>
                        </div>

                        <div style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 15px; border: 1px solid var(--card-border);">
                            <p><b>3Ô∏è‚É£ MIST SYSTEM CONTROL</b></p>
                            <p style="font-size: 0.8rem; color: var(--text-dim);">
                                <span style="color: #2ecc71;">‚úÖ Trigger:</span> Temp > 28¬∞C AND Hum < 60%<br>
                                <span style="color: var(--danger);">‚ùå Safety:</span> Do NOT mist if Hum ‚â• 80%<br>
                                <span style="color: var(--primary);">üîÅ Logic:</span> Pulse 10‚Äì30s if conditions met.
                            </p>
                            <p><b>4Ô∏è‚É£ WATER PUMP CONTROL</b></p>
                            <p style="font-size: 0.8rem; color: var(--text-dim);">
                                <span style="color: #2ecc71;">‚úÖ Trigger:</span> Soil < 25% | <span style="color: var(--danger);">‚ùå Stop:</span> Soil ‚â• 50%<br>
                                <span style="color: var(--primary);">üîÅ Logic:</span> Maintain moisture between thresholds.
                            </p>
                        </div>

                        <div style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 15px; border: 1px solid var(--card-border); grid-column: span 1;">
                            <p><b>5Ô∏è‚É£ PRIORITY & SAFETY (üö®)</b></p>
                            <p style="font-size: 0.8rem; color: var(--text-dim);">
                                <b>Extreme Heat (‚â• 35¬∞C):</b> Fan ON, Mist ON, Pump OFF.<br>
                                <i>Reason: Cooling is priority; prevents root rot.</i>
                            </p>
                            <p><b>6Ô∏è‚É£ SYSTEM TIMING RULES</b></p>
                            <table style="width: 100%; font-size: 0.75rem; color: var(--text-dim); border-collapse: collapse;">
                                <tr style="border-bottom: 1px solid #333;"><td>Fan</td><td>Continuous</td></tr>
                                <tr style="border-bottom: 1px solid #333;"><td>Mist</td><td>Pulse (10-30s ON)</td></tr>
                                <tr><td>Pump</td><td>Max 2‚Äì5 min cycle</td></tr>
                            </table>
                            <p style="color: var(--danger); font-size: 0.7rem; font-weight: 800; margin-top: 10px;">‚õî NEVER KEEP MIST OR PUMP ON CONTINUOUSLY</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="v-logs" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                <h1>Data Records</h1>
                <button class="btn" style="background:var(--primary); color:white;" onclick="exportPDF()">Export PDF</button>
            </div>
            <div class="card" style="padding: 0; overflow: hidden;">
                <table style="width:100%; border-collapse:collapse; text-align: left;">
                    <thead style="background: rgba(0,0,0,0.05);">
                        <tr><th style="padding:15px;">Time</th><th>Temp</th><th>Hum</th><th>Soil</th></tr>
                    </thead>
                    <tbody id="log-table" style="color: var(--text-dim);"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

        const config = {
            apiKey: "AIzaSyD-gYivB1ye0UYiCKMSimVNaJm8dwWVHsE",
            databaseURL: "https://greenmind-5f7f3-default-rtdb.firebaseio.com",
            projectId: "greenmind-5f7f3"
        };

        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let history = [];
        let lastStates = { fan: false, mist: false, pump: false };
        let pumpTimer;

        window.expandSidbar = () => document.getElementById('sidebar').classList.remove('collapsed');
        window.collapseSidebar = () => document.getElementById('sidebar').classList.add('collapsed');

        window.toggleTheme = () => {
            document.body.classList.toggle('light-mode');
            const icon = document.querySelector('[onclick="toggleTheme()"] span');
            icon.innerText = document.body.classList.contains('light-mode') ? 'light_mode' : 'dark_mode';
        };

        window.login = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
        };
        window.logout = () => signOut(auth).then(() => location.reload());
        onAuthStateChanged(auth, user => { if(user) document.getElementById('auth-screen').style.display='none'; });

        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: [], 
                datasets: [
                    { label: 'Temp', borderColor: '#ff6b6b', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0 },
                    { label: 'Hum', borderColor: '#48dbfb', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0 },
                    { label: 'Soil', borderColor: '#f1c40f', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0 }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    y: { grid: { color: 'rgba(127,127,127,0.1)' }, min: 0, max: 100 }, 
                    x: { display: false } 
                },
                plugins: {
                    legend: { position: 'top', labels: { color: '#888', font: { size: 9 }, usePointStyle: true, boxWidth: 5 } }
                }
            }
        });

        ['f', 'm', 'p'].forEach(key => {
            document.getElementById(`${key}-tog`).addEventListener('change', (e) => {
                const map = { f: 'fan', m: 'mist', p: 'pump' };
                const state = e.target.checked;
                set(ref(db, `greenhouse/${map[key]}`), state);

                if(key === 'p' && state) {
                    document.getElementById('pump-timer').style.visibility = 'visible';
                    clearTimeout(pumpTimer);
                    pumpTimer = setTimeout(() => {
                        set(ref(db, `greenhouse/pump`), false);
                        document.getElementById('pump-timer').style.visibility = 'hidden';
                        addLog("Safety: Pump Auto-Stopped after 10s");
                    }, 10000);
                } else if (key === 'p' && !state) {
                    document.getElementById('pump-timer').style.visibility = 'hidden';
                    clearTimeout(pumpTimer);
                }
            });
        });

        function addLog(msg) {
            const box = document.getElementById('status-box');
            const time = new Date().toLocaleTimeString();
            const html = `<div class="log-entry"><span class="log-time">[${time}]</span> ${msg}</div>`;
            box.insertAdjacentHTML('afterbegin', html);
        }

        onValue(ref(db, 'greenhouse'), (snap) => {
            const d = snap.val();
            if(!d) return;

            document.getElementById('t').innerText = d.temp;
            document.getElementById('h').innerText = d.hum;
            document.getElementById('s').innerText = d.soil;

            document.getElementById('alert-t').style.display = d.temp > 30 ? 'block' : 'none';
            document.getElementById('alert-h').style.display = d.hum > 85 ? 'block' : 'none';
            document.getElementById('alert-s').style.display = d.soil < 40 ? 'block' : 'none';

            document.getElementById('f-tog').checked = d.fan;
            document.getElementById('m-tog').checked = d.mist;
            document.getElementById('p-tog').checked = d.pump;

            if(d.fan !== lastStates.fan) { addLog(`Exhaust Fan turned ${d.fan ? 'ON' : 'OFF'}`); lastStates.fan = d.fan; }
            if(d.mist !== lastStates.mist) { addLog(`Mist Maker turned ${d.mist ? 'ON' : 'OFF'}`); lastStates.mist = d.mist; }
            if(d.pump !== lastStates.pump) { addLog(`Water Pump turned ${d.pump ? 'ON' : 'OFF'}`); lastStates.pump = d.pump; }

            updateBadge('f-st', d.fan, 'icon-f');
            updateBadge('m-st', d.mist, 'icon-m');
            updateBadge('p-st', d.pump, 'icon-p');

            const now = new Date().toLocaleTimeString();
            history.push([now, d.temp + "¬∞C", d.hum + "%", d.soil + "%"]);
            document.getElementById('session-count').innerText = `Records: ${history.length}`;
            
            const row = `<tr style="border-top:1px solid rgba(127,127,127,0.1);"><td style="padding:15px;">${now}</td><td>${d.temp}¬∞C</td><td>${d.hum}%</td><td>${d.soil}%</td></tr>`;
            document.getElementById('log-table').insertAdjacentHTML('afterbegin', row);

            if(chart.data.labels.length > 15) { 
                chart.data.labels.shift(); 
                chart.data.datasets.forEach(ds => ds.data.shift());
            }
            chart.data.labels.push(now); 
            chart.data.datasets[0].data.push(d.temp); 
            chart.data.datasets[1].data.push(d.hum); 
            chart.data.datasets[2].data.push(d.soil); 
            chart.update();
        });

        function updateBadge(id, state, iconId) {
            const el = document.getElementById(id);
            el.className = state ? "status-pill active-on" : "status-pill";
            document.getElementById(iconId).style.color = state ? "#2ecc71" : "#888";
        }

        window.show = (id, el) => {
            ['v-dash', 'v-flow', 'v-logs'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        };

        window.exportPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("GreenMind Thesis Research Report", 14, 20);
            doc.autoTable({ head: [['Time', 'Temp', 'Hum', 'Soil']], body: history, startY: 30 });
            doc.save("Greenhouse_Data.pdf");
        };

        collapseSidebar();
    </script>
</body>
</html>